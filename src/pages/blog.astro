---
import Code from "../components/Code.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
import { server } from "../lib/actions";

const page = Astro.url.searchParams.get("page") ?? "1";
const perPage = Astro.url.searchParams.get("per_page") ?? "12";
const search = Astro.url.searchParams.get("search") ?? undefined;

const { data, error } = await server.getPosts({
  page: Number(page),
  perPage: Number(perPage),
  searchQuery: search,
});

if (error) console.error(error.message);

const posts = data?.posts;
const hasNext = data?.hasNext;
const hasPrevious = data?.hasPrevious;
---

<BaseLayout title={"Blog"}>
  <main class="flex min-h-screen flex-col p-12">
    <header class="w-full text-center space-x-2">
      <a href="/" class="link">Homepage</a>
      <a href={"/blog"} class="link">Blog</a>
      <a href="/projects" class="link">Projects</a>
      <a href="/rss.xml" class="link">RSS</a>
    </header>
    <section id="description" class="m-4">
      <Code
        as="h1"
        code="# Welcome to my blog!"
        lang={"markdown"}
        alignment="center"
      />
      <Code
        as="h2"
        code="## This is where I throw my random pieces of knowledge or experience I get for being a developer."
        lang={"markdown"}
        alignment="center"
      />
      <Code
        as="h3"
        code="### I encourage you to take a look. One wise man once said that what we have to say, will be useful to somebody."
        lang={"markdown"}
        alignment="center"
      />
    </section>
    <form class="w-full text-center mx-8 mt-2 mb-8" data-form>
      <input
        type="search"
        name="search"
        id="search"
        required
        minlength="2"
        maxlength="24"
        placeholder="Enter a search term..."
        class="w-1/2 rounded-lg p-2 bg-mocha border-2 border-sky-blue focus-within:border-light-blue text-white font-medium outline-none"
      />
    </form>
    <section
      id="posts"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"
    >
      {
        posts?.length === 0 && (
          <span class="w-full text-white m-2 justify-center text-center">
            There are no posts at this page. I don't know how you ended up here.
          </span>
        )
      }
      {
        posts &&
          posts.map((post) => {
            const {
              data: { title, summary, tags, createdDate, modifiedDate },
              slug,
            } = post;
            return (
              <a
                href={`/blog/${slug}?page=${page}&per_page=${perPage}${search ? `&search=${encodeURI(search)}` : ""}`}
                class="block w-full max-w-md p-6 bg-[#313244] rounded-lg shadow-lg hover:shadow-xl transform transition duration-500 hover:scale-105"
              >
                <h2 class="text-2xl font-bold text-[#CDD6F4] mb-2">{title}</h2>
                <p class="text-[#A6ADC8] mb-4">{summary}</p>
                <div class="flex flex-wrap items-center mb-4">
                  {tags.map((tag) => (
                    <span class="bg-[#45475A] text-[#F5E0DC] text-xs font-medium mr-2 px-2.5 py-0.5 rounded">
                      {tag}
                    </span>
                  ))}
                </div>
                <div class="text-sm text-[#BAC2DE]">
                  <p>Created: {createdDate}</p>
                  {createdDate !== modifiedDate && (
                    <p>Modified: {modifiedDate}</p>
                  )}
                </div>
              </a>
            );
          })
      }
    </section>
    <section
      id="pagination"
      class="w-full flex justify-center items-center m-4 space-x-4"
    >
      {
        hasPrevious && (
          <a
            href={`/blog?page=${Number(page) - 1}&per_page=${Number(perPage)}`}
            class="text-[#6CB4FF] hover:text-[#94D0FF] font-semibold"
          >
            Previous
          </a>
        )
      }
      <span class="text-white font-semibold">{Number(page)}</span>
      {
        hasNext && (
          <a
            href={`/blog?page=${Number(page) + 1}&per_page=${Number(perPage)}`}
            class="text-[#6CB4FF] hover:text-[#94D0FF] font-semibold"
          >
            Next
          </a>
        )
      }
    </section>
  </main>
  <script>
    const form = document.querySelector<HTMLFormElement>("[data-form]");
    if (!form) throw new Error("Search form was not found!");
    form.addEventListener("submit", (e: SubmitEvent) => {
      e.preventDefault();
      const formData = new FormData(form);
      const searchQuery = formData.get("search")?.toString();
      if (!searchQuery || searchQuery.trim().length === 0) return;
      const url = new URL("/blog", window.location.origin);
      url.searchParams.set("search", encodeURI(searchQuery));
      url.searchParams.set("page", Astro.url.searchParams.get("page") ?? "1");
      url.searchParams.set(
        "per_page",
        Astro.url.searchParams.get("per_page") ?? "12",
      );
      window.location.assign(url.toString());
      console.log(searchQuery);
      form.reset();
    });
  </script>
</BaseLayout>
